generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String         @id @default(cuid())
  privyId          String?        @unique
  clerkId          String?        @unique
  faucetPoints     Int            @default(100)
  points           Int            @default(0)
  profilePicture   String?
  bets             Bet[]
  firstName        String?
  lastName         String?
  fullName         String?
  email            String?        @unique
  phone            String?        @unique
  username         String?        @unique
  lastClaimedAt    DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  earlyAccess      Boolean        @default(false)
  degenMode        Boolean        @default(false)
  wallets          Wallet[]
  notifications    Notification[]
  transactions     Transaction[]
  UserLevel        UserLevel?
  sponsoredMarkets Market[]       @relation("CreatedMarkets")

  // Refferal system 
  referralCode String  @unique
  referredById String? // user who referred them
  referredBy   User?   @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]  @relation("Referrals")

  @@map("users")
}

model Wallet {
  id                  String         @id @default(cuid())
  ownerId             String
  name                String?
  publicKey           String
  encryptedPrivateKey String?        @db.Text
  walletSource        WalletSource   @default(CUSTOM)
  chain               Chain          @default(CHILIZ)
  delegated           Boolean        @default(false)
  active              Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  owner               User           @relation(fields: [ownerId], references: [id])
  transactions        Transaction[]
  notifications       Notification[]

  @@unique([ownerId, publicKey])
  @@map("wallets")
}

model Market {
  id               String         @id @default(cuid())
  title            String
  status           MarketStatus   @default(OPEN) // "open", "closed", "resolved"
  outcomes         Outcome[]
  marketType       MarketType     @default(CUSTOM)
  createdAt        DateTime       @default(now())
  coverUrl         String? //SOOON
  resolvedAt       DateTime?
  closedAt         DateTime?
  startsAt         DateTime       @default(now())
  endsAt           DateTime       @default(now())
  winningOutcomeId String? // ID of the winning outcome
  resolvedById     String?
  // Sponsorship
  creatorId        String?
  creator          User?          @relation("CreatedMarkets", fields: [creatorId], references: [id])
  sponsoredStake   Float          @default(0) // Locked stake
  feePercent       Float          @default(5.0) // Platform cut
  creatorFeeShare  Float          @default(50.0) // % of platform fee given to creator
  players          PlayerMarket[]

  // analytics
  totalPools        Float? // sum of all stakes
  totalLosers       Float? // sum of losing stakes
  platformFeeEarned Float? // fee taken by platform
  creatorFeeEarned  Float? // fee given to market creator
}

model Outcome {
  id           String @id @default(cuid())
  label        String // e.g. "Yes", "No"
  marketId     String
  market       Market @relation(fields: [marketId], references: [id])
  bets         Bet[]
  // These fields are updated every time a bet is placed
  totalStaked  Int    @default(0) // in points
  bettorsCount Int    @default(0) // unique users
}

model Bet {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  outcomeId       String
  outcome         Outcome   @relation(fields: [outcomeId], references: [id])
  amount          Int // in points
  oddsAtBet       Float? // odds calculated and saved at bet placement time
  potentialPayout Float? // amount * oddsAtBet (pre-calculated for convenience)
  status          BetStatus @default(PENDING) // "pending", "won", "lost"
  fee             Int?
  createdAt       DateTime  @default(now())
}

model SponsorEarning {
  id        String   @id @default(cuid())
  sponsorId String // user who owns the sponsored market
  marketId  String
  betId     String
  amount    Int
  createdAt DateTime @default(now())
}

model ReferralEarning {
  id               String   @id @default(cuid())
  referrerId       String
  referredId       String
  betId            String
  fromSponsorShare Boolean  @default(false) // was this earned from a sponsor's cut?
  amountEarned     Int
  source           String?
  createdAt        DateTime @default(now())
}

//CATEGIRISE PLAYERS AND MARKETS

model Player {
  id             String         @id @default(cuid())
  name           String
  teamId         String?
  profilePicture String?
  nationalityId  String?
  mainColor      String?
  stats          PlayerStat[]
  team           Team?          @relation(fields: [teamId], references: [id])
  nationality    Nationality?   @relation(fields: [nationalityId], references: [id])
  highlights     Highlight[]
  markets        PlayerMarket[]
  createdAt      DateTime       @default(now())
}

model Nationality {
  id      String   @id @default(cuid())
  name    String   @unique // e.g. "France", "Brazil"
  flag    String? // URL to flag image
  players Player[]
}

model Team {
  id       String   @id @default(cuid())
  name     String   @unique
  logo     String? // URL to team logo
  leagueId String?
  league   League?  @relation(fields: [leagueId], references: [id])
  players  Player[]
}

model League {
  id    String  @id @default(cuid())
  name  String  @unique
  logo  String? // Optional: league logo
  teams Team[]
}

model Highlight {
  id        String   @id @default(cuid())
  playerId  String
  player    Player   @relation(fields: [playerId], references: [id])
  title     String
  url       String // link to the video
  createdAt DateTime @default(now())
}

// JOIN TABLE FOR PLAYER MARKETS
model PlayerMarket {
  id       String @id @default(cuid())
  marketId String
  playerId String
  market   Market @relation(fields: [marketId], references: [id])
  player   Player @relation(fields: [playerId], references: [id])
}

// Player stats 
model PlayerStat {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])
  date        DateTime // Date of the stat (e.g., match date)
  goals       Int      @default(0)
  assists     Int      @default(0)
  minutes     Int      @default(0)
  yellowCards Int      @default(0)
  redCards    Int      @default(0)
  isInjured   Boolean  @default(false)

  createdAt DateTime @default(now())
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  title     String? // Short headline
  body      String? // Detailed message
  type      NotificationType
  link      String? // Optional link to view more (market, player, etc.)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  Wallet    Wallet?          @relation(fields: [walletId], references: [id])
  walletId  String?
}

model Transaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type          TransactionType
  amount        Float
  token         String? // e.g., "ETH", "POINT"
  description   String?
  transactionId String? // ID from the external transaction (if applicable)

  createdAt DateTime @default(now())
  Wallet    Wallet?  @relation(fields: [walletId], references: [id])
  walletId  String?
}

model UserLevel {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  level     Int      @default(1)
  xp        Int      @default(0)
  nextXp    Int      @default(100) // XP needed to reach next level
  updatedAt DateTime @updatedAt
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
  BET_PLACED
  BET_WON
  BET_LOST
  STAKE_REWARD
  LEVEL_UP_REWARD
  MARKET_CREATED
  REFERRAL_REWARD
  SPONSOR_REWARD
}

enum WalletSource {
  CUSTOM
  PRIVY
  SOCIOS
  METAMASK
  WALLET_CONNECT
}

enum Chain {
  SOLANA
  CHILIZ
  ETHEREUM
}

enum NotificationType {
  MARKET_RESOLVED
  BET_RESULT
  NEW_HIGHLIGHT
  NEW_MARKET
  STAKING_REWARD
  REWARD
}

enum MarketType {
  CUSTOM
  SPONSORED
  PARTENERSHIP
  FRIENDLY
  TOURNAMENT
}

enum MarketStatus {
  OPEN
  CLOSED
  PENDING
  DELAYED
  ENDED
  RESOLVED
}

enum BetStatus {
  WON
  LOST
  PENDING
}
